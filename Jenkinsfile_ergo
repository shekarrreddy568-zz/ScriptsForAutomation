
def schema_registry
def zookeeper
def template_path 
def schemas_dir
def remote = [:]
remote.name = 'kafka-broker'
remote.allowAnyHosts = true

pipeline {
  agent none
  environment {
	  GIT_CREDS = credentials('github_creds_for_jenkins')
	  SSH_CREDS = credentials('ssh_creds_e960438adm')
    }
  options { disableConcurrentBuilds() }

  stages {

		stage('transport to next stage') {
			agent { label 'linux' }
			when { environment name: 'BRANCH_NAME', value: "${env.TAG_NAME}" } 	
			steps{
				echo "TAG: ${env.TAG_NAME}"
				sh 'cp /var/lib/jenkins/transports.py .'

				script {
					template_path = "${env.WORKSPACE}/templates/MLK_EMGM.yml"
					schemas_dir = "\\\"${env.WORKSPACE}/schemas\\\""
					if ((env.TAG_NAME).startsWith('ERGO-v')) {
						zookeeper = "\\\"kfkte0p01111.linux.eden\\\""
						schema_registry = "\\\"https://kfkte0p01311.linux.eden:8081\\\""
						remote.host = 'kfkte0p01211.linux.eden'
						}
					echo "zookeeper: ${zookeeper}"
					echo "schema_registry: ${schema_registry}"
					}

					sh """
					python -c "import transports; transports.registerSchema(${schema_registry},${schemas_dir})" ${template_path}  
					"""
					script {
						remote.user = "${SSH_CREDS_USR}"
						remote.password = "${SSH_CREDS_PSW}"
					} 
					sshPut remote: remote, from: 'templates/MLK_EMGM.yml', into: '.'
					sshPut remote: remote, from: './transports.py', into: '.'
					sshCommand remote: remote, command: """sudo python -c "import transports; transports.createTopic(${zookeeper})" MLK_EMGM.yml"""
					sshRemove remote: remote, path: "./MLK_EMGM.yml"
					sshRemove remote: remote, path: "./transports.py"
					sshRemove remote: remote, path: "./transports.pyc"
			}
		}

    
  }
}
